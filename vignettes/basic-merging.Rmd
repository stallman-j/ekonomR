---
title: "Basic Merging"
layout: single
toc: true
toc_label: "Contents"
toc_sticky: true
author_profile: true
date: "2024-10-22"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic-merging}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```


**Make sure** you've got the latest version of `ekonomR`. It's getting updated frequently. 

If you're not sure if your `ekonomR` is up to date or you're new to the woods, you may want to check out the vignette [Getting Started with ekonomR](https://stallman-j.github.io/ekonomR/vignettes/getting-started-with-ekonomR/), and the [Coding Review](https://stallman-j.github.io/ekonomR/vignettes/coding-review/) for a couple key operations I'll be assuming you know.

# Prerequisites

I'm also going to assume that you already know the concepts we discussed in the basic cleaning vignettes. In particular, there's a discussion regarding and a simple example of merging in [Basic Cleaning: Global Carbon Budget](https://stallman-j.github.io/ekonomR/vignettes/basic-cleaning_gcb/), so you might want to go there first if you haven't already and you're new to the R neck of the woods.

If you're just looking for a script that merges the World Population Prospects population data, the Penn World Tables gross domestic product (GDP) data, and the Global Carbon Budget greenhouse gas emissions data, you've also come to the right place and you might want to just copy the final code at the end.

First, bring `ekonomR` into your working library.

``` {r}
library(ekonomR)
```

To make this vignette self-containing,

``` {r, eval = FALSE}

data(gcb_clean)
data(pwt_clean)
data(wpp_clean)

# merge them all together ----

  # gcb is the one with the most country-year obs so start with that

  merged_data <- gcb %>%
                  dplyr::left_join(wpp, by = c("year","iso3c")) %>%
    dplyr::left_join(pwt, by = c("iso3c","year")) %>%
    dplyr::left_join(iea, by = c("iso3c","year","country_name")) %>%
                  dplyr::relocate(where(is.numeric), .after = tidyselect::where(is.character)) %>% # rearrange columns so countrynames are first
    dplyr::filter(!is.na(rgdpe) & !is.na(pop_000)) %>% # keep only if the GDP and population data are there
    dplyr::arrange(iso3c,year) %>% # arrange by country-year
    dplyr::mutate(pop = pop_000*1000,
                         gdp_pc = (rgdpe*1000000) / pop,
                         gcb_ghg_territorial_pc = (gcb_ghg_territorial*1000000)/pop,
                         gcb_ghg_consumption_pc = gcb_ghg_consumption*1000000/pop,
                         gcb_ghg_transfers_pc   = gcb_ghg_transfers*1000000/pop,
                         iea_ghg_energy_pc      = iea_ghg_energy*1000000/pop,
                         iea_ghg_fugitive_pc    = iea_ghg_fugitive*1000000/pop,
                         iea_ghg_fc_pc          = iea_ghg_fc*1000000/pop,
                         iea_ghg_fc_coal_pc     = iea_ghg_fc_coal*1000000/pop,
                         iea_ghg_fc_oil_pc      = iea_ghg_fc_oil*1000000/pop,
                         iea_ghg_fc_gas_pc      = iea_ghg_fc_gas*1000000/pop,
                         gdp000_pc              = (rgdpe*1000)/pop,
                         log_iea_ghg_fc_pc      = log(iea_ghg_fc_pc),
                         log_gcb_ghg_consumption_pc = log(gcb_ghg_consumption_pc))

  # you can define the log values as variables themselves or just do
  # it within a regression

  names(merged_data) # display the varnames

  # examine some summaries
  #summary(merged_data$log_iea_ghg_fc_pc)
  #summary(merged_data$log_gcb_ghg_consumption_pc)


  merged_data <- ekonomR::save_rds_csv(data = merged_data,
                          output_path   = file.path(data_clean),
                          output_filename = paste0("ghg_pop_gdp.rds"),
                          remove = FALSE,
                          csv_vars = names(merged_data),
                          format   = "both")
```
